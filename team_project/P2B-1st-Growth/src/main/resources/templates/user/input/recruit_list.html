<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{common/layout :: html(
        title=${mode == 'all' ? 'å‹Ÿé›†ä¸€è¦§' : 'ã‚ãªãŸã®å‹Ÿé›†ä¸€è¦§'},
        pageCss=~{user/input/recruit_list :: pageCss},
        body=~{user/input/recruit_list :: body}
      )}">

<head th:fragment="pageCss">
  <link rel="stylesheet" th:href="@{/css/recruit/recruit_card.css}">
</head>

<section th:fragment="body">
  <div class="recruit-page">
    <div class="recruit-head">
      <h1 th:text="${mode == 'all' ? 'å‹Ÿé›†ä¸€è¦§' : 'ã‚ãªãŸã®å‹Ÿé›†ä¸€è¦§'}">å‹Ÿé›†ä¸€è¦§</h1>
      <p class="recruit-sub">å·¦ã§é¸ã¶ã¨ã€å³ã«è©³ç´°ãŒå‡ºã¾ã™ã€‚</p>
    </div>

    <!-- ğŸ” æ¤œç´¢ï¼ˆæ—¢å­˜æ©Ÿèƒ½ã¯æ®‹ã—ã¾ã™ï¼šè¡¨ç¤ºã¯ all ã®æ™‚ã ã‘ã§ã™ï¼‰ -->
    <form th:if="${mode == 'all'}"
          th:action="@{/recruitment/search}"
          method="get"
          class="search-box">

      <!-- âœ… modeå›ºå®šã§é€ä¿¡ã—ã¾ã™ï¼ˆmodeã‚ºãƒ¬äº‹æ•…é˜²æ­¢ã®ãŸã‚ã§ã™ï¼‰ -->
      <input type="hidden" name="mode" value="all">

      <div class="search-row">
        <input type="text" name="keyword"
               th:value="${keyword != null ? keyword : (param.keyword != null ? param.keyword : '')}"
               placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¢ã™">

        <button type="button" class="btn-filter" id="filterBtn"
                aria-expanded="false" aria-controls="filterPanel">
          çµã‚Šè¾¼ã¿æ¡ä»¶ <span id="filterCount" class="filter-count" aria-hidden="true"></span>
        </button>

        <button type="submit" class="btn-search">æ¤œç´¢</button>
        <a class="btn-reset" th:href="@{/recruitment/all}">ãƒªã‚»ãƒƒãƒˆ</a>
      </div>

      <div class="filter-panel" id="filterPanel" aria-hidden="true" role="dialog" aria-label="çµã‚Šè¾¼ã¿æ¡ä»¶">
        <div class="filter-head">
          <div class="filter-title">çµã‚Šè¾¼ã¿æ¡ä»¶</div>
          <button type="button" class="btn-close" id="filterClose" aria-label="é–‰ã˜ã‚‹">Ã—</button>
        </div>

        <div class="filter-grid">

          <!-- éƒ¨æ´» -->
          <div class="fbox">
            <div class="flabel">éƒ¨æ´»</div>
            <label class="chk" th:each="c : ${clubs}">
              <input type="checkbox"
                     name="clubId"
                     th:value="${c.clubId}"
                     th:checked="${paramValues != null and paramValues['clubId'] != null and #lists.contains(paramValues['clubId'], #strings.toString(c.clubId))}">
              <span th:text="${c.clubName}">ã‚µãƒƒã‚«ãƒ¼</span>
            </label>
          </div>

          <!-- æ—¥ç¨‹ -->
          <div class="fbox">
            <div class="flabel">æ—¥ç¨‹</div>
            <label class="chk" th:each="o : ${altDateOptions}">
              <input type="checkbox"
                     name="altDateOption"
                     th:value="${o.name()}"
                     th:checked="${paramValues != null and paramValues['altDateOption'] != null and #lists.contains(paramValues['altDateOption'], o.name())}">
              <span th:text="${o.label}">æœªæŒ‡å®š</span>
            </label>
          </div>

          <!-- äººæ•° -->
          <div class="fbox">
            <div class="flabel">äººæ•°</div>
            <label class="chk" th:each="capa : ${capacityRanges}">
              <input type="checkbox"
                     name="capacityRange"
                     th:value="${capa.name()}"
                     th:checked="${paramValues != null and paramValues['capacityRange'] != null and #lists.contains(paramValues['capacityRange'], capa.name())}">
              <span th:text="${capa.label}">6ã€œ10äºº</span>
            </label>
          </div>

          <!-- æ€§åˆ¥ -->
          <div class="fbox">
            <div class="flabel">æ€§åˆ¥</div>
            <label class="chk" th:each="g : ${genderPrefs}">
              <input type="checkbox"
                     name="genderPref"
                     th:value="${g.name()}"
                     th:checked="${paramValues != null and paramValues['genderPref'] != null and #lists.contains(paramValues['genderPref'], g.name())}">
              <span th:text="${g.label}">ç”·å¥³æ··åˆ</span>
            </label>
          </div>

          <!-- ç§»å‹• -->
          <div class="fbox">
            <div class="flabel">ç§»å‹•</div>
            <label class="chk" th:each="t : ${travelOptions}">
              <input type="checkbox"
                     name="travelOption"
                     th:value="${t.name()}"
                     th:checked="${paramValues != null and paramValues['travelOption'] != null and #lists.contains(paramValues['travelOption'], t.name())}">
              <span th:text="${t.label}">å‰å¾Œæ—¥OK</span>
            </label>
          </div>

          <!-- å¯¾è±¡ãƒãƒ¼ãƒ  -->
          <div class="fbox">
            <div class="flabel">å¯¾è±¡ãƒãƒ¼ãƒ </div>
            <label class="chk" th:each="tt : ${targetTeams}">
              <input type="checkbox"
                     name="targetTeam"
                     th:value="${tt.name()}"
                     th:checked="${paramValues != null and paramValues['targetTeam'] != null and #lists.contains(paramValues['targetTeam'], tt.name())}">
              <span th:text="${tt.label}">é«˜æ ¡ç”Ÿ</span>
            </label>
          </div>

          <!-- è©¦åˆå†…å®¹ -->
          <div class="fbox">
            <div class="flabel">è©¦åˆå†…å®¹</div>
            <label class="chk" th:each="mc : ${matchContents}">
              <input type="checkbox"
                     name="matchContent"
                     th:value="${mc.name()}"
                     th:checked="${paramValues != null and paramValues['matchContent'] != null and #lists.contains(paramValues['matchContent'], mc.name())}">
              <span th:text="${mc.label}">ç·´ç¿’è©¦åˆ</span>
            </label>
          </div>

          <!-- ãƒãƒ¼ãƒ ãƒ¬ãƒ™ãƒ« -->
          <div class="fbox">
            <div class="flabel">ãƒãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«</div>
            <label class="chk" th:each="lv : ${teamLevels}">
              <input type="checkbox"
                     name="teamLevel"
                     th:value="${lv.name()}"
                     th:checked="${paramValues != null and paramValues['teamLevel'] != null and #lists.contains(paramValues['teamLevel'], lv.name())}">
              <span th:text="${lv.label}">å…¨å›½ãƒ™ã‚¹ãƒˆ8</span>
            </label>

            <div style="margin-top:8px; padding-top:8px; border-top:1px solid #e3f3e3;">
              <label class="chk">
                <input type="checkbox" id="noPref"
                       name="noPreference" value="1"
                       th:checked="${paramValues != null and paramValues['noPreference'] != null and #lists.contains(paramValues['noPreference'], '1')}">
                <span>ã“ã ã‚ã‚‰ãªã„</span>
              </label>
            </div>
          </div>

        </div>

        <div class="filter-actions">
          <button type="submit" class="btn-apply">ã“ã®æ¡ä»¶ã§çµã‚Šè¾¼ã‚€</button>
          <button type="button" class="btn-clear" id="filterClear">ãƒã‚§ãƒƒã‚¯å¤–ã™</button>
        </div>
      </div>
    </form>

    <p class="search-msg"
       th:if="${message != null and !#strings.isEmpty(message)}"
       th:text="${message}"></p>

    <p class="empty" th:if="${#lists.isEmpty(recruitments)}">ç¾åœ¨ã€å‹Ÿé›†ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>

    <div class="recruit-split" th:if="${!#lists.isEmpty(recruitments)}">

      <div class="recruit-left">
        <div class="recruit-card-list">
          <article class="recruit-card"
                   th:each="r : ${recruitments}"
                   th:attr="data-id=${r.recruitId}">
            <div class="recruit-avatar" aria-hidden="true">
              <img class="recruit-avatar-img"
                   th:if="${r.user != null and r.user.iconPath != null and !#strings.isEmpty(r.user.iconPath)}"
                   th:src="@{${r.user.iconPath}}"
                   alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³">
              <span class="recruit-avatar-initial"
                    th:unless="${r.user != null and r.user.iconPath != null and !#strings.isEmpty(r.user.iconPath)}"
                    th:text="${(r.user != null and r.user.name != null and !#strings.isEmpty(r.user.name))
                              ? #strings.substring(r.user.name,0,1)
                              : 'æ•™'}">æ•™</span>
            </div>

            <div class="recruit-content">
              <div class="recruit-title-row">
                <h2 class="recruit-title">
                  <span th:text="${r.clubMaster != null ? r.clubMaster.clubName : 'éƒ¨æ´»æœªè¨­å®š'}">éƒ¨æ´»</span>
                  <span class="dot">ãƒ»</span>
                  <span th:text="${r.title != null && !#strings.isEmpty(r.title) ? r.title : 'ã‚¿ã‚¤ãƒˆãƒ«æœªè¨­å®š'}">ã‚¿ã‚¤ãƒˆãƒ«</span>
                </h2>
              </div>

              <div class="recruit-chips">
                <span class="recruit-chip"
                      th:text="${r.altDateOption != null ? r.altDateOption.label : 'æœªæŒ‡å®š'}">æœªæŒ‡å®š</span>

                <span class="recruit-chip"
                      th:text="${r.capacityRange != null ? r.capacityRange.label : 'æœªæŒ‡å®š'}">æœªæŒ‡å®š</span>

                <span class="recruit-chip"
                      th:if="${r.noPreference != null and r.noPreference == 1}">ã“ã ã‚ã‚‰ãªã„</span>

                <th:block th:unless="${r.noPreference != null and r.noPreference == 1}">
                  <span class="recruit-chip"
                        th:if="${r.genderPref != null}"
                        th:text="${r.genderPref.label}">ç”·å¥³æ··åˆ</span>

                  <span class="recruit-chip"
                        th:if="${r.teamLevelText != null && !#strings.isEmpty(r.teamLevelText)}"
                        th:text="${r.teamLevelText}">å…¨å›½ãƒ™ã‚¹ãƒˆ8</span>

                  <span class="recruit-chip"
                        th:if="${r.matchContentText != null && !#strings.isEmpty(r.matchContentText)}"
                        th:text="${r.matchContentText}">ç·´ç¿’è©¦åˆ</span>

                  <span class="recruit-chip"
                        th:if="${r.travelOption != null}"
                        th:text="${r.travelOption.label}">å‰å¾Œæ—¥OK</span>

                  <span class="recruit-chip"
                        th:if="${r.targetTeamText != null && !#strings.isEmpty(r.targetTeamText)}"
                        th:text="${r.targetTeamText}">é«˜æ ¡ç”Ÿ</span>
                </th:block>
              </div>
            </div>

            <!-- âœ… å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆmine ã®æ™‚ã ã‘è¡¨ç¤ºã—ã¾ã™ï¼‰ -->
            <div class="recruit-actions" th:if="${mode != 'all'}">
              <!-- âœ… æ—¢å­˜ã®ã‚¢ã‚¯ã‚»ã‚¹å…ˆã¯å¤‰æ›´ã—ã¾ã›ã‚“ -->
              <form th:action="@{/recruitment/delete}" method="post"
                    onsubmit="event.stopPropagation(); return confirm('ã“ã®å‹Ÿé›†ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');">
                <!-- âœ… å‹Ÿé›†IDã‚’é€ä¿¡ã„ãŸã—ã¾ã™ -->
                <input type="hidden" name="recruitId" th:value="${r.recruitId}">
                <!-- âœ… modeã‚‚é€ä¿¡ã„ãŸã—ã¾ã™ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆã®åˆ¤æ–­ã«åˆ©ç”¨ã™ã‚‹ãŸã‚ã§ã™ï¼‰ -->
                <input type="hidden" name="mode" th:value="${mode}">
                <!-- âœ… ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã®é¸æŠå‡¦ç†ã¸ä¼æ’­ã—ãªã„ã‚ˆã†ã«ã—ã¦ãŠã‚Šã¾ã™ -->
                <button type="submit" class="btn-delete" onclick="event.stopPropagation();">å‰Šé™¤</button>
              </form>
            </div>
          </article>
        </div>
      </div>

      <aside class="recruit-right">
        <div class="detail-panel">
          <div class="detail-head">
            <div class="detail-title">è©³ç´°</div>
            <div class="detail-sub">ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã™ã‚‹ã¨ã“ã¡ã‚‰ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
          </div>

          <div id="detailBody" class="detail-body">å·¦ã®ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>

          <!-- âœ… å¿œå‹Ÿãƒœã‚¿ãƒ³ã¯ all ã®æ™‚ã ã‘ï¼ˆæ—¢å­˜é€šã‚Šã§ã™ï¼‰ -->
          <div class="detail-footer" th:if="${mode == 'all'}">
            <a id="applyBtn" class="btn-apply is-disabled" href="#" aria-disabled="true"
               onclick="return applyGuard();">
              å¿œå‹Ÿç”»é¢ã«é€²ã‚€
            </a>
          </div>
        </div>
      </aside>

    </div>

    <div class="recruit-bottom">
      <a class="btn" th:if="${mode != 'all'}" th:href="@{/recruitment/input}">æ–°ã—ã„å‹Ÿé›†ã‚’ä½œæˆ</a>
      <a class="btn" th:if="${mode == 'all'}" th:href="@{/recruitment/list}">ã‚ãªãŸã®å‹Ÿé›†ã¸</a>
      <a class="btn ghost" th:if="${mode != 'all'}" th:href="@{/recruitment/all}">å‹Ÿé›†ä¸€è¦§ã¸</a>
    </div>
  </div>

  <script th:inline="javascript">
    const ctx = /*[[@{/}]]*/ "/";

    function applyGuard(){
      const btn = document.getElementById("applyBtn");
      return btn && !btn.classList.contains("is-disabled");
    }

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
    }

    function md(dateOrDateTime){
      const s = String(dateOrDateTime ?? "").trim();
      if(!s) return "";
      const d = s.includes("T") ? s.split("T")[0] : s.split(" ")[0];
      const p = d.split("-");
      if(p.length < 3) return d;
      const m = Number(p[1]);
      const day = Number(p[2]);
      if(!m || !day) return d;
      return `${m}-${day}`;
    }

    function hm(dateTime){
      const s = String(dateTime ?? "").trim();
      if(!s) return "";
      const t = s.includes("T") ? s.split("T")[1] : s.split(" ")[1];
      return String(t ?? "").slice(0,5);
    }

    function buildTimeline(scheduleText){
      const s = String(scheduleText ?? "").trim();
      if(!s) return `<div class="tl-empty">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æœªè¨­å®š</div>`;

      const lines = s.includes("\n")
        ? s.split("\n").map(x=>x.trim()).filter(Boolean)
        : s.split(/(?=\d{1,2}:\d{2})/).map(x=>x.trim()).filter(Boolean);

      const items = lines.map(line=>{
        const m = line.match(/^(\d{1,2}:\d{2})\s*(.*)$/);
        if(m){
          return { time:m[1], text:(m[2]||"").trim() || "å†…å®¹æœªè¨­å®š" };
        }
        return { time:"", text:line };
      });

      return `
        <div class="timeline">
          ${items.map(it=>`
            <div class="tl-item">
              <div class="tl-time">${it.time ? esc(it.time) : ""}</div>
              <div class="tl-dot"></div>
              <div class="tl-text">${esc(it.text)}</div>
            </div>
          `).join("")}
        </div>
      `;
    }

    function buildMap(addr){
      const a = String(addr ?? "").trim();
      if(!a) return `<div class="map-empty">å ´æ‰€æœªè¨­å®š</div>`;
      const q = encodeURIComponent(a);
      return `
        <iframe
          class="map-iframe"
          loading="lazy"
          referrerpolicy="no-referrer-when-downgrade"
          src="https://www.google.com/maps?q=${q}&output=embed">
        </iframe>
      `;
    }

    function chip(label, value){
      const v = String(value ?? "").trim();
      if(!v) return "";
      return `
        <div class="detail-chip">
          <span class="label">${esc(label)}</span>
          <span class="value">${esc(v)}</span>
        </div>
      `;
    }

    async function selectRecruit(el){
      const id = el?.dataset?.id;
      if(!id) return;

      document.querySelectorAll(".recruit-card.is-selected")
        .forEach(x => x.classList.remove("is-selected"));
      el.classList.add("is-selected");

      const res = await fetch(`${ctx}recruitment/api/detail?id=${id}`);
      const data = await res.json();

      const detail = document.getElementById("detailBody");
      if(!detail) return;

      if(data.error){
        detail.textContent = "è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ãŸã°ã„â€¦";
        return;
      }

      const start = String(data.startDateTime ?? "");
      const end   = String(data.endDateTime ?? "");

      const dateMMDD = md(start);
      const startHM = hm(start);
      const endHM   = hm(end);

      detail.innerHTML = `
        <div class="d-title">${esc(data.clubName)} ãƒ» ${esc(data.title)}</div>

        <div class="detail-when">
          <div class="detail-when-date">${esc(dateMMDD)}</div>
          <div class="detail-when-time">
            <span class="badge">æ—¥ç¨‹</span>
            <span class="time">${esc(startHM || start)}</span>
            <span class="sep">ã€œ</span>
            <span class="time">${esc(endHM || end)}</span>
          </div>
        </div>

        <div class="detail-chips">
          ${chip("åˆ¥æ—¥ç¨‹", data.altDateOption)}
          ${chip("äººæ•°", data.capacityRange)}
          ${chip("æ€§åˆ¥", data.genderPref)}
          ${chip("ç§»å‹•", data.travelOption)}
          ${chip("å¯¾è±¡", data.targetTeam)}
          ${chip("å†…å®¹", data.matchContent)}
          ${chip("ãƒ¬ãƒ™ãƒ«", data.teamLevel)}
        </div>

        <div class="place-wrap">
          <div class="place-box">
            <div class="place-title">å ´æ‰€</div>
            <div class="place-addr">${esc(data.locationText || "æœªè¨­å®š")}</div>
          </div>
          <div class="detail-map">
            ${buildMap(data.locationText)}
          </div>
        </div>

        <div class="detail-textbox">
          <div class="detail-textbox-title">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</div>
          <div class="detail-textbox-body">
            ${buildTimeline(data.scheduleText)}
          </div>
        </div>

        <div class="detail-textbox">
          <div class="detail-textbox-title">å½¢å¼</div>
          <div class="detail-textbox-body">${esc(data.matchFormat || "æœªè¨­å®š")}</div>
        </div>

        <div class="detail-textbox">
          <div class="detail-textbox-title">å‚™è€ƒ</div>
          <div class="detail-textbox-body">${esc(data.notes || "ãªã—")}</div>
        </div>
      `;

      const btn = document.getElementById("applyBtn");
      if(btn){
        btn.classList.remove("is-disabled");
        btn.removeAttribute("aria-disabled");
        btn.href = `${ctx}application/apply?recruitId=${id}`;
      }
    }

    function updateFilterCount(){
      const panel = document.getElementById("filterPanel");
      const countEl = document.getElementById("filterCount");
      if(!panel || !countEl) return;

      const checked = panel.querySelectorAll('input[type="checkbox"]:checked').length;
      if(checked <= 0){
        countEl.textContent = "";
        countEl.style.display = "none";
      }else{
        countEl.textContent = String(checked);
        countEl.style.display = "inline-flex";
      }
    }

    function bindNoPreference(){
      const panel = document.getElementById("filterPanel");
      const noPref = document.getElementById("noPref");
      if(!panel || !noPref) return;

      const targets = panel.querySelectorAll(
        'input[name="targetTeam"], input[name="matchContent"], input[name="teamLevel"]'
      );

      const sync = () => {
        if(noPref.checked){
          targets.forEach(ch => ch.checked = false);
        }
        updateFilterCount();
      };

      noPref.addEventListener("change", sync);

      targets.forEach(ch => ch.addEventListener("change", () => {
        if(ch.checked) noPref.checked = false;
        updateFilterCount();
      }));

      sync();
    }

    window.addEventListener("DOMContentLoaded", () => {
      // âœ… å³è¡¨ç¤ºï¼ˆä¸€è¦§ã¯ mine/all é–¢ä¿‚ãªãå‹•ã‹ã—ã¾ã™ï¼‰
      document.querySelectorAll(".recruit-card").forEach(card => {
        card.addEventListener("click", () => selectRecruit(card));
      });

      const first = document.querySelector(".recruit-card");
      if(first) selectRecruit(first);

      // âœ… çµã‚Šè¾¼ã¿UIï¼ˆall ã®æ™‚ã ã‘è¦ç´ ãŒã‚ã‚‹ãŸã‚ã€å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã—ã¦ã‹ã‚‰å‹•ã‹ã—ã¾ã™ï¼‰
      const btn   = document.getElementById("filterBtn");
      const panel = document.getElementById("filterPanel");
      const close = document.getElementById("filterClose");
      const clear = document.getElementById("filterClear");

      if(!btn || !panel) return;

      const openPanel = () => {
        panel.classList.add("is-open");
        panel.setAttribute("aria-hidden","false");
        btn.setAttribute("aria-expanded","true");
      };

      const closePanel = () => {
        panel.classList.remove("is-open");
        panel.setAttribute("aria-hidden","true");
        btn.setAttribute("aria-expanded","false");
      };

      closePanel();

      btn.addEventListener("click", () => {
        panel.classList.contains("is-open") ? closePanel() : openPanel();
      });

      close?.addEventListener("click", closePanel);

      clear?.addEventListener("click", () => {
        panel.querySelectorAll("input[type=checkbox]").forEach(ch => ch.checked = false);
        updateFilterCount();
      });

      panel.addEventListener("change", (e) => {
        if(e.target && e.target.matches('input[type="checkbox"]')) updateFilterCount();
      });

      updateFilterCount();
      bindNoPreference();
    });
  </script>
</section>
</html>
