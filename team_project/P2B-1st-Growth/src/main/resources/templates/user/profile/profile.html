<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{common/layout :: html(
        title=${'プロフィール'},
        pageCss=~{::link},
        body=~{::section}
      )}">

<head>
  <!-- ✅ ページ専用CSSだけ（共通はlayoutが読む） -->
  <link rel="stylesheet" th:href="@{/css/profile/profile.css}">
</head>

<section>
  <div class="profile-wrap">

    <h2>プロフィール</h2>

    <!-- アイコン表示（URL化＋null対策） -->
    <div class="profile-icon-wrap"
         th:with="icon=${(user != null and user.iconPath != null) ? user.iconPath : '/icon/default.png'}">
      <img th:src="@{${icon}}" class="profile-icon" alt="profile">
    </div>

    <p>名前：<span th:text="${user != null ? user.name : '未設定'}"></span></p>
    <p>メール：<span th:text="${user != null ? user.email : '未設定'}"></span></p>
    <p>学校：<span th:text="${user != null ? user.school : '未設定'}"></span></p>
    <p>部活：<span th:text="${user != null and user.club != null ? user.club.clubName : '未設定'}"></span></p>

    <hr>

    <h3>プロフィールアイコン変更</h3>
    <form th:action="@{/user/icon/upload}" method="post" enctype="multipart/form-data">
      <input type="file" name="iconFile" accept="image/*" required>
      <button type="submit">変更する</button>
    </form>

    <hr>

    <h3>大会記録アップロード</h3>
    <form th:action="@{/user/profile/record/upload}" method="post" enctype="multipart/form-data">
      <input type="text" name="title" placeholder="大会名・タイトル（任意）">
      <input type="file" name="file" accept=".jpg,.jpeg,.png,.pdf" required>
      <button type="submit">アップロード</button>
    </form>

    <hr>

    <h3>大会記録</h3>

    <div th:if="${#lists.isEmpty(records)}">まだ記録ないよ〜</div>

    <ul th:if="${!#lists.isEmpty(records)}">
      <li th:each="r : ${records}" class="record-item">

        <div class="record-date">
          <span th:text="${#dates.format(r.uploadedAt, 'yyyy/MM/dd HH:mm')}"></span>
        </div>

        <div class="record-title">
          タイトル：
          <span th:text="${r.title != null and !#strings.isEmpty(r.title) ? r.title : '（未設定）'}"></span>
        </div>

        <div class="record-file">
          ファイル：
          <span th:text="${r.originalName}"></span>
          /
          <a th:href="@{/user/profile/record/file/{id}(id=${r.id})}" target="_blank">開く</a>

          <form th:action="@{/user/profile/record/delete/{id}(id=${r.id})}"
                method="post" style="display:inline;">
            <button type="submit" onclick="return confirm('削除する？')">削除</button>
          </form>
        </div>

        <div th:if="${r.contentType != null and r.contentType.startsWith('image/')}"
             class="record-preview">
          <img th:src="@{/user/profile/record/file/{id}(id=${r.id})}" alt="preview">
        </div>

        <div th:if="${r.contentType != null and r.contentType.startsWith('application/pdf')}"
             class="record-pdf">
          ※PDFは「開く」から見れるよ
        </div>

        <hr>
      </li>
    </ul>

    <a class="profile-edit-link" th:href="@{/user/profile/edit}">プロフィール編集</a>

  </div>
</section>
</html>
